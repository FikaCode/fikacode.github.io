<!DOCTYPE html>
<html>
<head>
<link rel="shortcut icon" href="https://fikacode.github.io/favicon.ico" type="image/x-icon" /><meta name="viewport"content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/><meta name="apple-mobile-web-app-capable"content="yes"/><meta name="apple-mobile-web-app-status-bar-style"content="black"/><meta name="format-detection"content="telephone=no"/><meta name="renderer"content="webkit"><meta name="description"content="玻璃晴朗，橘子辉煌"><meta charset="UTF-8"><title>Spring Security 自定义权限实现 redis token 登陆验证 | Drinker</title>
<link href="https://fikacode.github.io/styles/main.css" type="text/css" rel="stylesheet" /><link href="https://at.alicdn.com/t/font_1621793_zatzzgvf30g.css" type="text/css" rel="stylesheet" /><link rel="stylesheet" href="https://fikacode.github.io/media/css/katex.css"><script async src="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.min.js"></script><script src="https://fikacode.github.io/media/js/magnify.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
<script type="text/javascript">function btn_toggle(){document.getElementById("hn").classList.contains("no-js")?document.getElementById("hn").classList.remove("no-js"):document.getElementById("hn").classList.add("no-js")}</script>

<link rel="canonical" href="https://fikacode.github.io/post/springSecurityTokenLogin/" />
</head>
<body>
<div class="progress"></div><style>.progress{background:linear-gradient(to right,#87ceeb var(--scroll),transparent 0);background-repeat:no-repeat;position:fixed;width:100%;height:4px;z-index:1}</style><div class="darkmode-background"></div><div class="darkmode-layer"></div>
<noscript><p class="warn" >本页面需要浏览器支持（启用）JavaScript</p></noscript><div class="header"><div class="logo_title"><div class="title animated fadeInDown"><a href="https://fikacode.github.io"><img alt="logo" style="display:inline-block;" src="https://fikacode.github.io/images/avatar.png"/></a><h1 title="Drinker" class="weaklink"><a  href="/">Drinker</a></h1>

<style>.santa-body{float:left;margin:10.5px 7.5px 0px 0px;font-size:20px;color:#f91047;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-webkit-align-items:center;-ms-flex-align:center;align-items:center;width:1em;height:1em;background-color:currentColor;-webkit-box-shadow:inset 0 -0.25em rgba(0,0,0,0.1);box-shadow:inset 0 -0.25em rgba(0,0,0,0.1);border-radius:50%;-webkit-transform-origin:center bottom;-ms-transform-origin:center bottom;transform-origin:center bottom;-webkit-animation:balance alternate infinite 2s ease-in-out;animation:balance alternate infinite 2s ease-in-out;}.santa-head{font-size:.4em;width:1em;height:1.9em;background-color:white;border-radius:.5em;-webkit-transform:translateY(-1em);-ms-transform:translateY(-1em);transform:translateY(-1em);position:relative;}.santa-head::before{content:'';width:1em;height:.375em;display:block;background-color:#ff9876;position:absolute;left:0;top:.65em;}.santa-ear{background-color:#fc8363;width:.1em;height:.3em;position:absolute;top:.75em;}.santa-ear:nth-of-type(1){border-radius:.05em 0 0 .05em;left:-0.1em;}.santa-ear:nth-of-type(2){border-radius:0 .05em .05em 0;right:-0.1em;}.santa-hat{content:'';width:1em;height:.15em;position:absolute;-webkit-transform:scale(1.1);-ms-transform:scale(1.1);transform:scale(1.1);top:.5em;left:0;background-color:white;}.santa-hat::before{content:'';display:block;width:1em;height:.5em;background:#f91047;border-radius:.5em .5em 0 0;z-index:2;position:absolute;top:-0.5em;}.santa-hat::after{content:'';width:.25em;height:.25em;display:block;background-color:white;border-radius:50%;position:absolute;z-index:0;top:-0.72em;right:0;-webkit-box-shadow:-0.2em .2em 0 .12em rgba(0,0,0,0.2),-0.2em .2em 0 .12em #f91047;box-shadow:-0.2em .2em 0 .12em rgba(0,0,0,0.2),-0.2em .2em 0 .12em #f91047;}.santa-eye{width:.12em;height:.12em;background-color:black;border-radius:50%;position:absolute;top:.76em;left:.2em;}.santa-eye + .santa-eye{left:auto;right:.2em;}.santa-nose{width:.12em;height:.22em;background-color:#f24c4c;border-radius:0 0 .12em .12em;position:absolute;top:.84em;left:50%;-webkit-transform:translateX(-50%);-ms-transform:translateX(-50%);transform:translateX(-50%);}.santa-mouth{width:.18em;height:.1em;border-bottom-right-radius:5vw;border-bottom-left-radius:5vw;margin-top:.3em;background-color:black;position:absolute;left:50%;top:50%;-webkit-transform:translate(-50%,-50%);-ms-transform:translate(-50%,-50%);transform:translate(-50%,-50%);-webkit-animation:hohoho 4s linear forwards infinite;animation:hohoho 4s linear forwards infinite;}@-webkit-keyframes hohoho{0%,10%,20%,40%,100%{width:.18em;height:.1em;border-bottom-right-radius:1vw;border-bottom-left-radius:1vw;}5%,15%,25%,35%{width:.15em;height:.2em;border-radius:50%;}}@keyframes hohoho{0%,10%,20%,40%,100%{width:.18em;height:.1em;border-bottom-right-radius:1vw;border-bottom-left-radius:1vw;}5%,15%,25%,35%{width:.15em;height:.2em;border-radius:50%;}}@-webkit-keyframes balance{from{-webkit-transform:rotate(-4deg);transform:rotate(-4deg);}to{-webkit-transform:rotate(4deg);transform:rotate(4deg);}}@keyframes balance{from{-webkit-transform:rotate(-4deg);transform:rotate(-4deg);}to{-webkit-transform:rotate(4deg);transform:rotate(4deg);}}</style>
<div class="santa"><div class="santa-body"><div class="santa-head"><div class="santa-ear"></div><div class="santa-ear"></div><div class="santa-hat"></div><div class="santa-eye"></div><div class="santa-eye"></div><div class="santa-nose"></div><div class="santa-mouth"></div></div></div></div>

<div class="navbar weaklink">
<div class="normal_nav">
<div class="bitcron_nav_container"><div class="bitcron_nav"><div class="bitcron_nav"><div style="display:flex;justify-content:center;"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >首页</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >归档</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >标签</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >关于</a></li></ul></nav>
<div style="float:right;margin-top:1em"><form id="gridea-search-form" data-update="1578893743252" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="Search..."></form></div><div style="margin-left:0.5em;margin-top:1.2em"><input id="switch_default" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
<div class="clear clear_nav_inline_end"></div></div></div><div class="clear clear_nav_end"></div></div></div><div class="hamberger" href="javascript:void(0)" onclick="btn_toggle();"><i class="iconfont icon-category"></i></div></div></div></div>
<div id="hn" class="no-js hidden_nav animated fadeInDown"><div class="bitcron_nav_container"><div class="bitcron_nav"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >首页</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >归档</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >标签</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >关于</a></li></ul><div class="clear clear_nav_inline_end"></div></nav></div><div class="clear clear_nav_end"></div></div>
<div style="display:flex;justify-content:center;inline-block;text-align:center;margin-top:7%"><div><form id="gridea-search-form" data-update="1609321601233" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q"  placeholder="Search..." /></form></div><div style="margin-left:0.5em"><input id="switch_default_h" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
</div></div>
<script>function enableDarkmode(){document.body.classList.add("darkmode"),document.getElementById("switch_default").checked=1,document.getElementById("switch_default_h").checked=1}function removeDarkmode(){document.body.classList.remove("darkmode"),document.getElementById("switch_default").checked=0,document.getElementById("switch_default_h").checked=0}function getCookie(a){var b,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null}cookie=getCookie("darkmode"),"enable"==cookie&&enableDarkmode(),window.matchMedia("(prefers-color-scheme: dark)").matches&&"disable"!==cookie&&(enableDarkmode(),document.cookie="darkmode=enable; path=/");var mobileBtn=function(){1==document.getElementById("switch_default").checked?(enableDarkmode(),document.cookie="darkmode=enable; path=/"):(removeDarkmode(),document.cookie="darkmode=disable; path=/")};</script>

<style>.deng-box{position:fixed;top:-40px;left:-80px;z-index:9999}.deng-box1{position:fixed;top:-30px;left:-80px;z-index:9999}.deng-box1 .deng{position:relative;width:120px;height:90px;margin:50px;background:#d8000f;background:rgba(216,0,15,0.8);border-radius:50% 50%;-webkit-transform-origin:50% -100px;-webkit-animation:swing 5s infinite ease-in-out;box-shadow:-5px 5px 30px 4px rgba(252,144,61,1)}.deng{position:relative;width:120px;height:90px;margin:50px;background:#d8000f;background:rgba(216,0,15,0.8);border-radius:50% 50%;-webkit-transform-origin:50% -100px;-webkit-animation:swing 3s infinite ease-in-out;box-shadow:-5px 5px 50px 4px rgba(250,108,0,1)}.deng-a{width:100px;height:90px;background:#d8000f;background:rgba(216,0,15,0.1);margin:12px 8px 8px 8px;border-radius:50% 50%;border:2px solid #dc8f03}.deng-b{width:45px;height:90px;background:#d8000f;background:rgba(216,0,15,0.1);margin:-4px 8px 8px 26px;border-radius:50% 50%;border:2px solid #dc8f03}.xian{position:absolute;top:-20px;left:60px;width:2px;height:20px;background:#dc8f03}.shui-a{position:relative;width:5px;height:20px;margin:-5px 0 0 59px;-webkit-animation:swing 4s infinite ease-in-out;-webkit-transform-origin:50% -45px;background:#ffa500;border-radius:0 0 5px 5px}.shui-b{position:absolute;top:14px;left:-2px;width:10px;height:10px;background:#dc8f03;border-radius:50%}.shui-c{position:absolute;top:18px;left:-2px;width:10px;height:35px;background:#ffa500;border-radius:0 0 0 5px}.deng:before{position:absolute;top:-7px;left:29px;height:12px;width:60px;content:" ";display:block;z-index:999;border-radius:5px 5px 0 0;border:solid 1px #dc8f03;background:#ffa500;background:linear-gradient(to right,#dc8f03,#ffa500,#dc8f03,#ffa500,#dc8f03)}.deng:after{position:absolute;bottom:-7px;left:10px;height:12px;width:60px;content:" ";display:block;margin-left:20px;border-radius:0 0 5px 5px;border:solid 1px #dc8f03;background:#ffa500;background:linear-gradient(to right,#dc8f03,#ffa500,#dc8f03,#ffa500,#dc8f03)}.deng-t{font-family:华文行楷,Arial,Lucida Grande,Tahoma,sans-serif;color:#dc8f03;font-weight:bold;line-height:85px;text-align:center}.night .deng-t,.night .deng-box,.night .deng-box1{background:transparent !important}@-moz-keyframes swing{0%{-moz-transform:rotate(-10deg)}50%{-moz-transform:rotate(10deg)}100%{-moz-transform:rotate(-10deg)}}@-webkit-keyframes swing{0%{-webkit-transform:rotate(-10deg)}50%{-webkit-transform:rotate(10deg)}100%{-webkit-transform:rotate(-10deg)}}</style>
<div class="deng-box"><div class="deng"><div class="xian"></div><div class="deng-a"><div class="deng-b"><div class="deng-t">节</div></div></div><div class="shui shui-a"><div class="shui-c"></div><div class="shui-b"></div></div></div></div> <div class="deng-box1"><div class="deng"><div class="xian"></div><div class="deng-a"><div class="deng-b"><div class="deng-t">春节</div></div></div><div class="shui shui-a"><div class="shui-c"></div><div class="shui-b"></div></div></div></div>

<div class="main"><div class="main-inner"><div class="content">
<article class="post">
<h2 class="post_title sm_margin"><a>Spring Security 自定义权限实现 redis token 登陆验证</a></h2>
<script>function lan(){if(document.getElementById("lan").innerText=="繁"){var s=document.getElementById("tongwenlet_cn");if(s!=null){document.body.removeChild(s)}var s=document.createElement("script");s.language="javascript";s.type="text/javascript";s.src="https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_tw.js";s.id="tongwenlet_cn";document.body.appendChild(s);document.getElementById("lan").innerHTML="简"}else{if(document.getElementById("lan").innerText=="簡"){var s=document.getElementById("tongwenlet_cn");if(s!=null){document.body.removeChild(s)}var s=document.createElement("script");s.language="javascript";s.type="text/javascript";s.src="https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_cn.js";s.id="tongwenlet_cn";document.body.appendChild(s);document.getElementById("lan").innerHTML="繁"}}};</script>
<section class="post_details"><i class="iconfont icon-calendar"></i><span style="margin-right:15px"> 2020-12-30</span><i class="iconfont icon-browse"></i><span style="margin-right:15px"> <span id="busuanzi_value_page_pv"></span> Views</span><i class="iconfont icon-category"></i><span class="weaklink" style="margin-right:15px">	<a href="https://fikacode.github.io/tag/springSecurity/" class="tag">spring security</a> | 	<a href="https://fikacode.github.io/tag/spring boot/" class="tag">spring boot</a> | 	<a href="https://fikacode.github.io/tag/Java/" class="tag">Java</a></span><i class="iconfont icon-caret-down"></i><span style="margin-right:15px">3619字</span><i class="iconfont icon-naozhong"></i><span style="margin-right:15px">20 min read</span><a id="lan" href="javascript:void(0);"onclick="lan();"title="调整简繁体" style="margin-right:15px;">繁</a>
</section>

<div style="display:flex">
<div class="md_block" id="md_block">
<div class="round-shape-one"></div>
<h2 id="前言">前言</h2>
<p>  本文的实现方式主要针于与对<code>spring security</code>有所了解的读者，通过增加<code>filter</code>的方式，替换代替<code>spring security</code>自带的的能登陆逻辑。</p>
<h2 id="准备工作">准备工作</h2>
<h4 id="pom-配置">pom 配置</h4>
<pre><code>    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.2.2.RELEASE&lt;/version&gt;
    &lt;/parent&gt;

   &lt;dependencies&gt;
        &lt;!-- spring security --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- redis --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;redis.clients&lt;/groupId&gt;
            &lt;artifactId&gt;jedis&lt;/artifactId&gt;
            &lt;version&gt;3.2.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- redis --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- JPA --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- 链接mysql --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- jwt --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.auth0&lt;/groupId&gt;
            &lt;artifactId&gt;java-jwt&lt;/artifactId&gt;
            &lt;version&gt;3.9.0&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
</code></pre>
<blockquote>
<p>其他的pom配置这里不在贴出，有需要的可自行添加。</p>
</blockquote>
<h4 id="redis-配置">redis 配置</h4>
<p>  RedisTemplate要来读取缓存在redis里面的token，登陆的时候需要使用到。这里为了以后扩展方便，使用RedisStandaloneConfiguration的方式配置RedisTemplate，可以自由配置端口和数据库。<br>
<br/></p>
<pre><code>package com.auth.frame.security.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisStandaloneConfiguration;
import org.springframework.data.redis.connection.jedis.JedisClientConfiguration;
import org.springframework.data.redis.connection.jedis.JedisConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.data.redis.serializer.StringRedisSerializer;

import java.time.Duration;

/**
 * @ClassName SecurityRedisConfig
 * @Author WFS
 * @Date 2020/1/21 15:56
 */
@Configuration
public class SecurityRedisConfig {

    @Bean(&quot;sysTokenRedisTemplate&quot;)
    public RedisTemplate&lt;String, String&gt; getTokenRedisTemplate() {
        return buildRedisTemplateByDataBase(10);
    }

    private RedisTemplate&lt;String, String&gt; buildRedisTemplateByDataBase(Integer dataBase) {
        RedisTemplate&lt;String, String&gt; template = new StringRedisTemplate();
        RedisStandaloneConfiguration redisStandaloneConfiguration = new RedisStandaloneConfiguration();
        redisStandaloneConfiguration.setHostName(&quot;localhost&quot;);
        redisStandaloneConfiguration.setPort(6379);
        redisStandaloneConfiguration.setDatabase(dataBase);
        JedisClientConfiguration.JedisClientConfigurationBuilder clientConfiguration = JedisClientConfiguration.builder();
        clientConfiguration.connectTimeout(Duration.ofSeconds(60));
        JedisConnectionFactory codeFactory = new JedisConnectionFactory(redisStandaloneConfiguration,
                clientConfiguration.build());
        template.setConnectionFactory(codeFactory);
        template.setValueSerializer(new StringRedisSerializer());
        template.setKeySerializer(new StringRedisSerializer());
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(new StringRedisSerializer());
        template.afterPropertiesSet();
        return template;
    }
}

</code></pre>
<h4 id="跨域配置">跨域配置</h4>
<p>  一般使用token的都是前后端分离，跨域这个问题总是要解决。springboot框架自带跨域的filter的配置，但是那个配置有些时候老是会有问题，我建议自己配置filter的方式来增加跨域的支持。</p>
<pre><code>package com.auth.frame.security.processor;

import org.springframework.web.bind.annotation.RequestMethod;

import javax.servlet.*;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

/**
 * @ClassName CROSFilter
 * @Author WFS
 * @Date 2020/2/7/0007 16:58
 */
public class CORSFilter implements Filter {
    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        HttpServletRequest request = (HttpServletRequest) servletRequest;
        HttpServletResponse response = (HttpServletResponse) servletResponse;
        String origin = request.getHeader(&quot;Origin&quot;);
        response.setHeader(&quot;Access-Control-Allow-Origin&quot;, origin);
        response.addHeader(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, PUT, DELETE, OPTIONS&quot;);
        response.addHeader(&quot;Access-Control-Allow-Headers&quot;,
                &quot;Content-Type, Authorization&quot;);
        response.addHeader(&quot;Access-Control-Allow-Credentials&quot;,
                &quot;true&quot;);
        if (RequestMethod.OPTIONS.toString().equals(request.getMethod())) {
            servletResponse.getWriter().println(&quot;ok&quot;);
            return;
        }
        filterChain.doFilter(request ,response);
    }

    @Override
    public void init(FilterConfig filterConfig) {

    }

    @Override
    public void destroy() {

    }
}
</code></pre>
<p>注册Filter</p>
<pre><code>package com.auth.frame.security.config;

import com.auth.frame.security.processor.CORSFilter;
import org.springframework.boot.web.servlet.FilterRegistrationBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * @ClassName FilterConfig
 * @Author WFS
 * @Date 2020/2/7/0007 16:57
 */
@Configuration
public class FilterConfig {
    @Bean(name = &quot;CORSFilter&quot;)
    public FilterRegistrationBean&lt;CORSFilter&gt; setFilter() {
        FilterRegistrationBean&lt;CORSFilter&gt; filterBean = new FilterRegistrationBean&lt;&gt;();
        filterBean.setFilter(new CORSFilter());
        filterBean.setOrder(Integer.MIN_VALUE);
        filterBean.setName(&quot;CORSFilter&quot;);
        filterBean.addUrlPatterns(&quot;/*&quot;);
        return filterBean;
    }
}

</code></pre>
<blockquote>
<ol>
<li>其余的选项可以按照自己的需求配置filter</li>
<li>filterBean.setOrder(Integer.MIN_VALUE); 保证了filter 第一个执行。</li>
</ol>
</blockquote>
<h2 id="原理">原理</h2>
<ol>
<li>
<h4 id="token-登陆">token 登陆</h4>
</li>
</ol>
<p>  spring security是由一大批filter组成，其中<code>UsernamePasswordAuthenticationFilter</code>是用户登陆验证时候的filter，我们要做的就是登陆验证之前检验token，如果token符合我们规则，那么从token里面取出授权信息，然后在<code>SecurityContextHolder</code>里面增加授权信息。这样，后面经过<code>UsernamePasswordAuthenticationFilter</code>时就不会使用自带的登陆验证逻辑检验。如果token不符合规则，直接滤过，<code>UsernamePasswordAuthenticationFilter</code>检验没有授权信息，会引导到登陆页面。</p>
<ol start="2">
<li>
<h4 id="自定义用户权限">自定义用户权限</h4>
</li>
</ol>
<p>  自定义用户权限主要用户来配合token做权限判断，从token里面取出来的授权信息就是关联我们的自定义权限。要实现自定义权限我们需要实现三个接口：<code>UserDetailsService</code>，该接口主要获取用户对应的权限；<code>FilterInvocationSecurityMetadataSource</code>启动项目时候所有url的权限信息；<code>AccessDecisionManager</code>投票器，根据用户的权限信息和url权限信息来实现允许或者拒绝的逻辑。</p>
<h2 id="用户信息表">用户信息表</h2>
<ol>
<li>
<h4 id="用户表">用户表</h4>
</li>
</ol>
<pre><code>package com.auth.frame.security.bean;


import com.auth.frame.common.BaseEntity;
import lombok.*;

import javax.persistence.*;
import java.util.Set;


@EqualsAndHashCode(callSuper = true)
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = &quot;t_sys_user&quot;, indexes = {@Index(columnList = &quot;id&quot;), @Index(columnList = &quot;phoneNum&quot;)})
public class User extends BaseEntity {
    @Column(unique = true)
    private String phoneNum;
    @Column(unique = true)
    private String userName;
    @Column
    private String salt;
    @Column
    private String passWord;
    @Column
    private Boolean accountNonExpired;
    @Column
    private Boolean accountNonLocked;
    @Column
    private Boolean credentialsNonExpired;
    @Column
    private Boolean enabled;
    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(name = &quot;t_sys_user_role&quot;, joinColumns = {@JoinColumn(name = &quot;user_id&quot;, referencedColumnName = &quot;id&quot;)}
            , inverseJoinColumns = {@JoinColumn(name = &quot;role_id&quot;, referencedColumnName = &quot;id&quot;)})
    private Set&lt;Role&gt; roles;

}
</code></pre>
<ol start="2">
<li>
<h4 id="角色表">角色表</h4>
</li>
</ol>
<pre><code>package com.auth.frame.security.bean;

import com.auth.frame.common.BaseEntity;
import lombok.*;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.Index;
import javax.persistence.Table;

@EqualsAndHashCode(callSuper = true)
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = &quot;t_sys_role&quot;, indexes = {@Index(columnList = &quot;id&quot;)})
public class Role extends BaseEntity {
    @Column
    private String name;
    @Column
    private String auth;
}
</code></pre>
<ol start="3">
<li>
<h4 id="url表">URL表</h4>
</li>
</ol>
<pre><code>package com.auth.frame.security.bean;


import com.auth.frame.common.BaseEntity;
import lombok.*;

import javax.persistence.*;
import java.util.Set;


@EqualsAndHashCode(callSuper = true)
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = &quot;t_sys_url&quot;, indexes = {@Index(columnList = &quot;id&quot;)})
public class URL extends BaseEntity {
    @Column
    private String name;
    @Column
    private String path;

    @ManyToMany (fetch = FetchType.EAGER)
    @JoinTable(name = &quot;t_sys_url_role&quot;, joinColumns = {@JoinColumn(name = &quot;url_id&quot;, referencedColumnName = &quot;id&quot;)}
            , inverseJoinColumns = {@JoinColumn(name = &quot;role_id&quot;, referencedColumnName = &quot;id&quot;)})
    private Set&lt;Role&gt; roles;
}
</code></pre>
<blockquote>
<ol>
<li>BaseEntity 主要是提供主键和创建、修改时间的字段。</li>
<li>注解中使用了 lombok。</li>
<li>角色、用户和URL使用的是单边对应，如有需要可改为多边对应。</li>
</ol>
</blockquote>
<h2 id="自定义认证">自定义认证</h2>
<ol>
<li>
<h4 id="userdetails">UserDetails</h4>
</li>
</ol>
<p>  UserDetails是spring security中的用户信息接口，通过实现UserDetails可以和User表关联起来。</p>
<pre><code>package com.auth.frame.security.processor;

import com.auth.frame.security.bean.User;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import java.util.Collection;

/**
 * @ClassName CSTUserDetailService
 * @Author WFS
 * @Date 2020/1/21 10:39
 */
@NoArgsConstructor
@AllArgsConstructor
@Data
public class CSTUserDetails implements UserDetails {
    private Collection&lt;SimpleGrantedAuthority&gt; authorities;
    private String username;
    private String userId;
    private Boolean accountNonExpired;
    private Boolean accountNonLocked;
    private Boolean credentialsNonExpired;
    private Boolean enabled;

    public CSTUserDetails(Collection&lt;SimpleGrantedAuthority&gt; authorities, String username, String userId, boolean accountNonExpired, boolean accountNonLocked, boolean credentialsNonExpired, boolean enabled) {
        this.authorities = authorities;
        this.username = username;
        this.userId = userId;
        this.accountNonExpired = accountNonExpired;
        this.accountNonLocked = accountNonLocked;
        this.credentialsNonExpired = credentialsNonExpired;
        this.enabled = enabled;
    }

    public CSTUserDetails(User user) {
        this.authorities = CSTUserDetailsService.getAuthorities(user);
        this.username = user.getUserName();
        this.userId = user.getId();
        this.accountNonExpired = user.getAccountNonExpired();
        this.accountNonLocked = user.getAccountNonLocked();
        this.credentialsNonExpired = user.getCredentialsNonExpired();
        this.enabled = user.getEnabled();
    }


    @Override
    public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() {
        return authorities;
    }

    @Override
    public String getPassword() {
        return null;
    }

    @Override
    public String getUsername() {
        return username;
    }

    @Override
    public boolean isAccountNonExpired() {
        return accountNonExpired;
    }

    @Override
    public boolean isAccountNonLocked() {
        return accountNonLocked;
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return credentialsNonExpired;
    }

    @Override
    public boolean isEnabled() {
        return enabled;
    }
}
</code></pre>
<blockquote>
<p><code>authorities</code>是用户对应的权限，其实就是一个字符串列表，可以自行拓展。</p>
</blockquote>
<ol start="2">
<li>
<h4 id="userdetailsservice">UserDetailsService</h4>
</li>
</ol>
<p>  UserDetailsService接口规定了通过用户名获取用户信息的接口，即获取UserDetails。</p>
<pre><code>package com.auth.frame.security.processor;

import com.auth.frame.security.bean.Role;
import com.auth.frame.security.bean.User;
import com.auth.frame.security.service.UserService;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Component;

import java.util.Collection;
import java.util.HashSet;
import java.util.Set;

/**
 * @ClassName CSTUserDetailsService
 * @Author WFS
 * @Date 2020/1/21 10:50
 */
@Component
public class CSTUserDetailsService implements UserDetailsService {


    private final UserService userService;

    public CSTUserDetailsService(UserService userService) {
        this.userService = userService;
    }

    @Override
    public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException {
        User user = userService.getCacheUser(s);
        if (user == null) {
            throw new UsernameNotFoundException(&quot;User Not Find!&quot;);
        } else {
            Collection&lt;SimpleGrantedAuthority&gt; authorities = getAuthorities(user);
            return new CSTUserDetails(authorities, user.getUserName(), user.getId(), user.getAccountNonExpired(), user.getAccountNonLocked(), user.getCredentialsNonExpired(), user.getEnabled());
        }
    }

    public static Collection&lt;SimpleGrantedAuthority&gt; getAuthorities(User user) {
        Set&lt;Role&gt; roleSet = user.getRoles();
        Collection&lt;SimpleGrantedAuthority&gt; authorities = new HashSet&lt;&gt;();
        if (roleSet != null &amp;&amp; !roleSet.isEmpty()) {
            roleSet.forEach(role -&gt; authorities.add(new SimpleGrantedAuthority(role.getAuth())));
        }
        return authorities;
    }
}
</code></pre>
<blockquote>
<p><code>loadUserByUsername</code>函数中的参数<code>s</code>即为用户名，<code>userService.getCacheUser</code>的作用是根据用户名获取用户，此处使用的自己写的从缓存获取用户名，可以自由发挥，只要能构建<code>UserDetails</code>即可。</p>
</blockquote>
<ol start="3">
<li>
<h4 id="filterinvocationsecuritymetadatasource">FilterInvocationSecurityMetadataSource</h4>
</li>
</ol>
<p>  <code>FilterInvocationSecurityMetadataSource</code>元数据，接口获取的是全部URL的权限信息和当http请求过来时候url对应的权限。其中<code>getAttributes</code>的参数<code>o</code>包含了当前访问的URL，根据URL我们需要返回对应的权限信息；<code>getAllConfigAttributes</code>会在项目启动时执行一次，获取所有URL对应的权限信息。</p>
<pre><code>package com.auth.frame.security.processor;

import com.auth.frame.security.bean.Role;
import com.auth.frame.security.repository.RoleRepository;
import com.auth.frame.security.service.URLService;
import org.springframework.security.access.ConfigAttribute;
import org.springframework.security.access.SecurityConfig;
import org.springframework.security.web.FilterInvocation;
import org.springframework.security.web.access.intercept.FilterInvocationSecurityMetadataSource;

import java.util.Collection;
import java.util.HashSet;
import java.util.Set;

import static com.auth.frame.security.config.ConstValue.ROLE.DEFAULT_ROLE;

/**
 * @ClassName CSTSecurityMetadataSource
 * @Author WFS
 * @Date 2020/1/21 17:06
 */
public class CSTSecurityMetadataSource implements FilterInvocationSecurityMetadataSource {

    private URLService urlService;

    private RoleRepository roleRepository;

    public CSTSecurityMetadataSource(URLService urlService, RoleRepository roleRepository) {
        this.urlService = urlService;
        this.roleRepository = roleRepository;
    }

    @Override
    public Collection&lt;ConfigAttribute&gt; getAttributes(Object o) throws IllegalArgumentException {
        String url = ((FilterInvocation) o).getRequestUrl();
        Collection&lt;ConfigAttribute&gt; configAttributes = new HashSet&lt;&gt;();
        Set&lt;Role&gt; roles = urlService.getCacheURL(url);
        roles.forEach(ele -&gt; configAttributes.add(new SecurityConfig(ele.getAuth())));
        if (configAttributes.isEmpty()) {
            configAttributes.add(new SecurityConfig(DEFAULT_ROLE));
        }
        return configAttributes;
    }

    @Override
    public Collection&lt;ConfigAttribute&gt; getAllConfigAttributes() {
        Collection&lt;ConfigAttribute&gt; configAttributes = new HashSet&lt;&gt;();
        roleRepository.findAllByDeletedIsFalse().forEach(e -&gt; configAttributes.add(new SecurityConfig(e.getAuth())));
        return configAttributes;
    }

    @Override
    public boolean supports(Class&lt;?&gt; aClass) {
        return true;
    }
}
</code></pre>
<ol start="4">
<li>
<h4 id="accessdecisionmanager">AccessDecisionManager</h4>
</li>
</ol>
<p>  投票管理器，接口规定了用户权限和URL权限之间的逻辑，即满足某种情况拒绝或者允许。</p>
<pre><code>package com.auth.frame.security.processor;

import org.springframework.security.access.AccessDecisionManager;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.access.ConfigAttribute;
import org.springframework.security.authentication.InsufficientAuthenticationException;
import org.springframework.security.core.Authentication;

import java.util.Collection;

import static com.auth.frame.security.config.ConstValue.ROLE.DEFAULT_ROLE;

/**
 * @ClassName CSTAccessDecisionManager
 * @Author WFS
 * @Date 2020/1/21 17:06
 */
public class CSTAccessDecisionManager implements AccessDecisionManager {
    @Override
    public void decide(Authentication authentication, Object o, Collection&lt;ConfigAttribute&gt; collection) throws AccessDeniedException, InsufficientAuthenticationException {
        if (collection.size() == 1 &amp;&amp; collection.stream().anyMatch(ele -&gt; DEFAULT_ROLE.equals(ele.getAttribute()))) {
            return;
        }
        if (!collection.stream().allMatch(ele -&gt; authentication.getAuthorities().stream().anyMatch(e -&gt; ele.getAttribute().equals(e.getAuthority())))) {
            throw new AccessDeniedException(&quot;AccessDenied!&quot;);
        }
    }

    @Override
    public boolean supports(ConfigAttribute configAttribute) {
        return Boolean.TRUE;
    }

    @Override
    public boolean supports(Class&lt;?&gt; aClass) {
        return Boolean.TRUE;
    }
}
</code></pre>
<p>  <code>Authentication</code>中包含有用户的权限信息，<code>Collection&lt;ConfigAttribute&gt;</code>包含有当前URL需要的权限信息，根据这两个参数我们就可以自由的指定我们投票规则。比如：某个URL含有多个权限，某个用户只要拥有其中一个就可以访问，或者要求必须全部拥有对应的权限才可以访问，此处可以自由发挥。需要注意的是，<strong><code>AccessDecisionManager</code>不起作用的情况，原因是如果<code>Collection&lt;ConfigAttribute&gt;</code>为<code>null</code>或者<code>empty</code>，则不会执行投票器，所以我们需要给没有配置权限的URL一个默认权限。</strong></p>
<h2 id="tokenfilter">tokenFilter</h2>
<p>  tokenFilter主要用来检查是否登陆的逻辑。先从请求里面获取token，解密，然后从reids里面获取相关权限信息；如果没有token则检查是否是用户名和密码，如果存在那么验证用户名和密码是否匹配，然后生成授权信息，存入redis，返回token给前端。</p>
<pre><code>package com.auth.frame.security.processor;

import com.auth.frame.common.ResponseEntity;
import com.auth.frame.common.Utils.JSONUtil;
import com.auth.frame.common.Utils.StringUtil;
import com.auth.frame.security.Utils.TokenUtil;
import com.auth.frame.security.bean.User;
import com.auth.frame.security.repository.UserRepository;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.util.DigestUtils;

import javax.annotation.Resource;
import javax.servlet.*;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.util.Set;
import java.util.UUID;
import java.util.concurrent.TimeUnit;

/**
 * @ClassName TokenFilter
 * @Author WFS
 * @Date 2020/1/21 10:47
 */
@Component
public class TokenFilter implements Filter {


    private final UserRepository userRepository;

    @Resource(name = &quot;sysTokenRedisTemplate&quot;)
    public RedisTemplate&lt;String, String&gt; redisTemplate;

    private static final String usernameParameter = &quot;username&quot;;
    private static final String passwordParameter = &quot;password&quot;;

    public TokenFilter(UserRepository userRepository) {
        this.userRepository = userRepository;
    }

    @Override
    public void init(FilterConfig filterConfig) {

    }

    @Override
    public void destroy() {

    }

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        HttpServletRequest request = (HttpServletRequest) servletRequest;
        HttpServletResponse response = (HttpServletResponse) servletResponse;
        String rds = TokenUtil.getBody(request);
        if (rds == null) {
            String username = request.getParameter(usernameParameter);
            String password = request.getParameter(passwordParameter);
            if (!StringUtil.isNullOrEmpty(username, password)) {
                User user = userRepository.findByDeletedIsFalseAndUserName(username);
                if (user != null) {
                    if (user.getAccountNonExpired() &amp;&amp; user.getAccountNonLocked() &amp;&amp; user.getCredentialsNonExpired() &amp;&amp; user.getEnabled()) {
                        if (!StringUtil.isNullOrEmpty(user.getSalt(), user.getPassWord())) {
                            if (user.getPassWord().equals(DigestUtils.md5DigestAsHex((password + user.getSalt()).getBytes(StandardCharsets.UTF_8)))) {
                                Set&lt;String&gt; rdsSet = redisTemplate.keys(&quot;*&quot;);
                                if (rdsSet != null) {
                                    for (String s : rdsSet) {
                                        String rc = redisTemplate.opsForValue().get(s);
                                        if (rc != null) {
                                            CSTUserDetails rc_u = JSONUtil.json2Obj(rc, CSTUserDetails.class);
                                            if (rc_u != null) {
                                                if (user.getId().equals(rc_u.getUserId())) {
                                                    redisTemplate.delete(s);
                                                }
                                            }
                                        }
                                    }
                                }
                                CSTUserDetails cstUserDetails = new CSTUserDetails(user);
                                String r = UUID.randomUUID().toString().replaceAll(&quot;-&quot;, &quot;&quot;);
                                redisTemplate.opsForValue().set(r, JSONUtil.obj2Json(cstUserDetails));
                                redisTemplate.expire(r, 2, TimeUnit.HOURS);
                                String token = TokenUtil.create(r);
                                ResponseEntity.ofToken(response, token);
                                return;
                            }
                        }
                    }
                }
            }
        } else {
            String cuStr = redisTemplate.opsForValue().get(rds);
            if (!StringUtil.isNullOrEmpty(cuStr)) {
                CSTUserDetails cu = JSONUtil.json2Obj(cuStr, CSTUserDetails.class);
                if (cu != null) {
                    if (cu.getAccountNonExpired() &amp;&amp; cu.getAccountNonLocked() &amp;&amp; cu.getCredentialsNonExpired() &amp;&amp; cu.getEnabled()) {
                        SecurityContextHolder.getContext().setAuthentication(new UsernamePasswordAuthenticationToken(cu.getUserId(), cu.getPassword(), cu.getAuthorities()));
                    }
                }
            }
        }
        filterChain.doFilter(servletRequest, servletResponse);
    }
}
</code></pre>
<blockquote>
<ol>
<li><code>TokenUtil</code> 主要从<code>request</code>里面解析<code>token</code>里面的<code>rds</code></li>
<li>中间有一段<code>redis</code>的操作，此处可以自行拓展，即每一个新的附带密码的请求都去删除<code>redis</code>里面相同<code>userId</code>的授权信息，这样做的好处是可以保证每个账号同一个时间只有一个人登陆。</li>
<li><code>ResponseEntity.ofToken()</code> 工具类，用于向<code>response</code>返回信息</li>
</ol>
</blockquote>
<h2 id="配置spring-security">配置<code>spring security</code></h2>
<p>  设置<code>withObjectPostProcessor</code>来设置<code>AccessDecisionManager</code>和<code>SecurityMetadataSource</code>，<code>addFilterBefore</code>设置<code>TokenFilter</code>的位置，<code>web.ignoring</code>设置开放<code>API</code>的路径，开放<code>API</code>不受<code>spring security</code>过滤链的控制。</p>
<pre><code>package com.auth.frame.security.config;

import com.auth.frame.security.processor.CSTAccessDecisionManager;
import com.auth.frame.security.processor.CSTSecurityMetadataSource;
import com.auth.frame.security.processor.CSTUserDetailsService;
import com.auth.frame.security.processor.TokenFilter;
import com.auth.frame.security.repository.RoleRepository;
import com.auth.frame.security.service.URLService;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.ObjectPostProcessor;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.builders.WebSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.access.intercept.FilterSecurityInterceptor;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.cors.CorsUtils;

/**
 * @ClassName SecurityConfig
 * @Author WFS
 * @Date 2020/1/21 10:25
 */
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(jsr250Enabled = true)
public class SecurityConfig extends WebSecurityConfigurerAdapter {


    private final CSTUserDetailsService cstUserDetailsService;
    private final ApplicationSecurityConfig applicationSecurityConfig;
    private final TokenFilter tokenFilter;

    private final URLService urlService;
    private final RoleRepository roleRepository;


    public SecurityConfig(CSTUserDetailsService cstUserDetailsService, ApplicationSecurityConfig applicationSecurityConfig, TokenFilter tokenFilter, URLService urlService, RoleRepository roleRepository) {
        this.cstUserDetailsService = cstUserDetailsService;
        this.applicationSecurityConfig = applicationSecurityConfig;
        this.tokenFilter = tokenFilter;
        this.urlService = urlService;
        this.roleRepository = roleRepository;
    }

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(cstUserDetailsService);
    }

    @Bean
    public CSTAccessDecisionManager getCSTAccessDecisionManager() {
        return new CSTAccessDecisionManager();
    }

    @Bean
    public CSTSecurityMetadataSource getCSTSecurityMetadataSource() {
        return new CSTSecurityMetadataSource(urlService, roleRepository);
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.csrf().disable().cors()
                .and().authorizeRequests()
                .withObjectPostProcessor(new ObjectPostProcessor&lt;FilterSecurityInterceptor&gt;() {
                    @Override
                    public &lt;O extends FilterSecurityInterceptor&gt; O postProcess(O o) {
                        o.setAccessDecisionManager(getCSTAccessDecisionManager());
                        o.setSecurityMetadataSource(getCSTSecurityMetadataSource());
                        return o;
                    }
                })
                .requestMatchers(CorsUtils::isPreFlightRequest).permitAll()
                .anyRequest().authenticated()
                .and().anonymous().disable().formLogin().permitAll()
                .and().addFilterBefore(tokenFilter, UsernamePasswordAuthenticationFilter.class)
                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);
    }

    @Override
    public void configure(WebSecurity web) {
        web.ignoring().regexMatchers(applicationSecurityConfig.getOpenApi());
    }
}
</code></pre>
<h2 id="结语">结语</h2>
<p>  通过以上逻辑，token登陆和自定义权限功能已经完成，其实所有的功能实现集中于<code>UserDetails</code>的构建和<code>AccessDecisionManager</code>投票逻辑，熟知于此就可以随意拓展Filter来实现自己的功能。</p>

<span id="footnote"></span>
<div id = "warn"></div>
</div>
<div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E5%89%8D%E8%A8%80">前言</a></li>
<li><a href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">准备工作</a><br>
*
<ul>
<li><a href="#pom-%E9%85%8D%E7%BD%AE">pom 配置</a></li>
<li><a href="#redis-%E9%85%8D%E7%BD%AE">redis 配置</a></li>
<li><a href="#%E8%B7%A8%E5%9F%9F%E9%85%8D%E7%BD%AE">跨域配置</a></li>
</ul>
</li>
<li><a href="#%E5%8E%9F%E7%90%86">原理</a><br>
*
<ul>
<li><a href="#token-%E7%99%BB%E9%99%86">token 登陆</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90">自定义用户权限</a></li>
</ul>
</li>
<li><a href="#%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E8%A1%A8">用户信息表</a><br>
*
<ul>
<li><a href="#%E7%94%A8%E6%88%B7%E8%A1%A8">用户表</a></li>
<li><a href="#%E8%A7%92%E8%89%B2%E8%A1%A8">角色表</a></li>
<li><a href="#url%E8%A1%A8">URL表</a></li>
</ul>
</li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81">自定义认证</a><br>
*
<ul>
<li><a href="#userdetails">UserDetails</a></li>
<li><a href="#userdetailsservice">UserDetailsService</a></li>
<li><a href="#filterinvocationsecuritymetadatasource">FilterInvocationSecurityMetadataSource</a></li>
<li><a href="#accessdecisionmanager">AccessDecisionManager</a></li>
</ul>
</li>
<li><a href="#tokenfilter">tokenFilter</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEspring-security">配置<code>spring security</code></a></li>
<li><a href="#%E7%BB%93%E8%AF%AD">结语</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="fullPage"><canvas id="canvas"></canvas></div>
</article>
<div id="eof"><span>EOF</span></div><div class="round-shape-one"></div>
<section>
<div class="doc_comments">

</div></section>
</div></div></div><script>
"use strict";!function(){for(var n=document.getElementsByTagName("pre"),e=n.length,s=0;s<e;s++){n[s].innerHTML='<span class="line-number"></span>'+n[s].innerHTML+'<span class="cl"></span>';for(var a=n[s].innerHTML.split(/\n/).length,r=0;r<a-1;r++){n[s].getElementsByTagName("span")[0].innerHTML+="<span>"+(r+1)+"</span>"}}}();
let mainNavLinks=document.querySelectorAll(".markdownIt-TOC a");window.addEventListener("scroll",event=>{let fromTop=window.scrollY;mainNavLinks.forEach((link,index)=>{let section=document.getElementById(decodeURI(link.hash).substring(1));let nextSection=null
if(mainNavLinks[index+1]){nextSection=document.getElementById(decodeURI(mainNavLinks[index+1].hash).substring(1));}
if(section.offsetTop<=fromTop){if(nextSection){if(nextSection.offsetTop>fromTop){link.classList.add("currentToc");}else{link.classList.remove("currentToc");}}else{link.classList.add("currentToc");}}else{link.classList.remove("currentToc");}});});
var list=document.querySelectorAll(".katex");for(var i=0;i<list.length;i++){list[i].style.display="unset"};
var h=document.documentElement,b=document.body,st="scrollTop",sh="scrollHeight",progress=document.querySelector(".progress"),scroll;document.addEventListener("scroll",function(){scroll=(h[st]||b[st])/((h[sh]||b[sh])-h.clientHeight)*100;progress.style.setProperty("--scroll",scroll+"%")});
var wxScale=new WxScale({fullPage:document.querySelector("#fullPage"),canvas:document.querySelector("#canvas")});var imgBox=document.querySelectorAll("#md_block img");for(var i=0;i<imgBox.length;i++){imgBox[i].onclick=function(e){wxScale.start(this)}};
content="本文最后更新于2020-12-30，已超过 1 年没有更新，涉及的内容可能已经失效！";var date1="2020-12-30 17:45:32";date1=date1.replace("-","/");var date2=new Date();var date3=date2.getTime()-new Date(date1).getTime();var days=Math.floor(date3/(24*3600*1000));if(days>=365){document.getElementById("warn").innerHTML=content};
</script>
<style>#magnifyImg{position:fixed;left:0;top:0;text-align:center;width:100%;display:none;z-index:9999}#magnifyImg img{object-fit:contain;background:#eaecef;padding:15px;border-radius:10px;height:auto;width:auto;vertical-align:middle}</style>
<a id="scrollUp" href="#top" style="position: fixed; z-index: 2147483647; display: block;"></a><div class="footer animated fadeInDown"><div class="site_footer"><div class="mysocials"><div class="my_socials"><a href="https://github.com/FikaCode"title="github"><i class="iconfont icon-github"></i></a><a href="mailto:wfs@wfscode.onmicrosoft.com"title="envelope"><i class="iconfont icon-envelope"></i></a></div></div><div class="copyright"id="copyright">Copyright © 2018-2020 <a href="https://fikacode.github.io" style="margin:0;">Drinker</a>.</div>
<span style="display: inline;margin-right:15px;">👁<strong><span id="busuanzi_value_site_uv"></span></strong></span><span id="busuanzi_container_page_pv" style="display: inline;"><span>📚<strong>6</strong> posts</span></div></div>
<script>
console.log("\n %c \u26a1Theme: Bitcron-pro Author's Blog:https://blog.blinkstar.cn  Writen By Serence  \n\n", "color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;", );
</script>
<script src="https://cdn.jsdelivr.net/npm/instant.page@3.0.0/instantpage.min.js" type="module" defer></script>
<script type="text/javascript" async src="https://fikacode.github.io/media/js/prism.js"></script>
</body>
</html>